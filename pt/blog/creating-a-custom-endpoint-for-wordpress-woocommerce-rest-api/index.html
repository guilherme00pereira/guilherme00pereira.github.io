<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <title>&lt;/G28&gt;</title>

  <!-- mobile responsive meta -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="This is meta description">
  
  <meta name="author" content="Guilherme Pereira">
  <meta name="generator" content="Hugo 0.59.1" />

  <!-- plugins -->
  
  <link rel="stylesheet" href="https://guilherme00pereira.github.io/plugins/bootstrap/bootstrap.min.css ">
  
  <link rel="stylesheet" href="https://guilherme00pereira.github.io/plugins/slick/slick.css ">
  
  <link rel="stylesheet" href="https://guilherme00pereira.github.io/plugins/themify-icons/themify-icons.css ">
  
  <link rel="stylesheet" href="https://guilherme00pereira.github.io/plugins/venobox/venobox.css ">
  

  <!-- Main Stylesheet -->
  
  <link rel="stylesheet" href="https://guilherme00pereira.github.io/scss/style.min.css" integrity="" media="screen">

  <!--Favicon-->
  <link rel="shortcut icon" href="https://guilherme00pereira.github.io/images/favicon.png " type="image/x-icon">
  <link rel="icon" href="https://guilherme00pereira.github.io/images/favicon.png " type="image/x-icon">

</head><body>
<!-- preloader start -->
<div class="preloader">
  
</div>
<!-- preloader end -->
<!-- navigation -->
<header class="navigation">
  <div class="container">
    
    <nav class="navbar navbar-expand-lg navbar-white bg-transparent border-bottom">
      <a class="navbar-brand mobile-view" href="https://guilherme00pereira.github.io/"><img class="img-fluid"
          src="https://guilherme00pereira.github.io/images/logo.png" alt="&lt;/G28&gt;"></a>
      <button class="navbar-toggler border-0" type="button" data-toggle="collapse" data-target="#navigation">
        <i class="ti-menu h3"></i>
      </button>

      <div class="collapse navbar-collapse text-center" id="navigation">
        

        <a class="navbar-brand mx-auto desktop-view" href="https://guilherme00pereira.github.io/"><img class="img-fluid"
            src="https://guilherme00pereira.github.io/images/logo.png" alt="&lt;/G28&gt;"></a>

        <ul class="navbar-nav ml-auto">
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://guilherme00pereira.github.io/blog">Artigos</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://guilherme00pereira.github.io/pt/sobre-mim">Sobre Mim</a>
          </li>
          
          
          
          <li class="nav-item">
            <a class="nav-link" href="https://guilherme00pereira.github.io/pt/contato">Contato</a>
          </li>
          
          
          
            
            <li class="nav-item">
                <a class="nav-link top-lang" href="https://guilherme00pereira.github.io/blog/creating-a-custom-endpoint-for-wordpress-woocommerce-rest-api/">en</a>
            </li>
            
        
        </ul>

        
        <!-- search -->
        <div class="search px-4">
          <button id="searchOpen" class="search-btn"><i class="ti-search"></i></button>
          <div class="search-wrapper">
            <form action="https://guilherme00pereira.github.io//search" class="h-100">
              <input class="search-box px-4" id="search-query" name="s" type="search" placeholder="Type & Hit Enter...">
            </form>
            <button id="searchClose" class="search-close"><i class="ti-close text-dark"></i></button>
          </div>
        </div>
        

        
      </div>
    </nav>
  </div>
</header>
<!-- /navigation -->

<section class="section-sm">
  <div class="container">
    <div class="row">
      <div class="col-lg-8 mx-auto">
        
        <a href="/pt/categories/wordpress"
          class="text-primary">Wordpress</a>
        
        <h2>Criando Endpoints Customizados para API do WordPress / WooCommerce</h2>
        <div class="mb-3"><span>By Guilherme Pereira</span> <span
            class="border-bottom border-primary px-2 mx-1"></span>
          <span>09 April 2019</span></div>
        <img src="https://guilherme00pereira.github.io/images/woocommerce.jpg" class="img-fluid w-100 mb-4" alt="Criando Endpoints Customizados para API do WordPress / WooCommerce">
        <div class="content mb-5">
          

<p>O WooCommerce tem uma REST API totalmente integrada à API do WordPress, que nos permite fazer solicitações no formato JSON para criar, ler, modificar e apagar dados de nossa loja. No entanto, às vezes, precisamos estender essa API, criando pontos de extremidade personalizados para retornar certos tipos de dados.</p>

<p>Neste tutorial, mostrarei passo a passo como criar um endpoint personalizado simples e espero que isso seja útil como ponto de partida para que se possa desenvolver chamadas mais complexas.</p>

<h2 id="criando-o-plugin">Criando o plugin</h2>

<p>Primeiramente, precisamos criar nosso plugin. A <a href="https://codex.wordpress.org/Writing_a_Plugin" target="_blank">documentação do WordPress</a> nos dá uma explicação completa sobre como criar um plugin próprio, mas basicamente o que temos que fazer é criar uma pasta dentro do diretório <strong>wp-content/plugins</strong> e dar um nome, como a seguir:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">mkdir woocommerce-custom-api-endpoint <span style="color:#f92672">&amp;&amp;</span> cd woocommerce-custom-api-endpoint</code></pre></div>

<p>Dentro desta pasta devemos criar um arquivo como o mesmo nome da pasta, o qual será nosso arquivo base do plugin:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">touch woocommerce-custom-api-endpoint.php</code></pre></div>

<h2 id="definindo-a-estrutura-básica">Definindo a Estrutura Básica</h2>

<p>Agora, no arquivo que criamos vamos escrever o seguinte código, com as seguintes partes (1, 2 e 3) que iremos explicar a seguir:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>

<span style="color:#75715e">// (1)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> <span style="color:#a6e22e">defined</span>( <span style="color:#e6db74">&#39;ABSPATH&#39;</span> ) ) {
	<span style="color:#66d9ef">exit</span>;
}

<span style="color:#75715e">// (2)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">function</span> <span style="color:#a6e22e">register_custom_routes</span>() {

}

<span style="color:#75715e">// (3)
</span><span style="color:#75715e"></span><span style="color:#a6e22e">add_action</span>(<span style="color:#e6db74">&#39;rest_api_init&#39;</span>, <span style="color:#e6db74">&#39;register_custom_routes&#39;</span>);

<span style="color:#75715e">?&gt;</span>
</code></pre></div>

<p>A primeira parte (1) do código evita o acesso direto ao arquivo. Em seguida (2), definimos uma função que irá fazer a chamada para o método da classe <strong>WC_Custom_Endpoints</strong>  que iremos criar a seguir, onde estarão configuradas as rotas da nossa API.  No passo (3) estaremos registrando nossos endpoints através do hook <a href="https://developer.wordpress.org/reference/hooks/rest_api_init/" target="_blank">rest_api_init</a>, passando como parâmetro a função criada. </p>

<h2 id="a-classe-wc-custom-endpoints">A Classe WC_Custom_Endpoints</h2>

<p>Agora vamos criar um novo arquivo que conterá nossa classe <strong>WC_Custom_Endpoints</strong>, onde estarão os métodos que tratarão as chamadas à nossa API. Para exemplarmos uma chamada à nossa API, criaremos um endpoint que retornará a listagem dos itens presentes nos pedidos com status &ldquo;Processando&rdquo;, ou seja, pedidos já pagos e pendentes de serem separados para envio, o que nos dará uma visão da quantidade de cada item a ser separado. Para isso definiremos a nossa classe com os seguintes métodos:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>

<span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> <span style="color:#a6e22e">defined</span>( <span style="color:#e6db74">&#39;ABSPATH&#39;</span> ) ) {
	<span style="color:#66d9ef">exit</span>;
}

                                 <span style="color:#75715e">// (1)
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">WC_Custom_Endpoint</span> <span style="color:#66d9ef">extends</span> <span style="color:#a6e22e">WP_REST_Controller</span>{

  <span style="color:#75715e">// (2)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">private</span> $local_wpdb;

  <span style="color:#75715e">// (3)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> __construct() {
    <span style="color:#66d9ef">global</span> $wpdb;
    $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">local_wpdb</span> <span style="color:#f92672">=</span> $wpdb;
  }

  <span style="color:#75715e">// (4)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">register_routes</span>() {

  }

  <span style="color:#75715e">// (5)
</span><span style="color:#75715e"></span>  <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">processing_order_items</span>() {
        
  }
}

<span style="color:#75715e">?&gt;</span>
</code></pre></div>

<p>Criamos então a classe <strong>WC_Custom_Endpoints</strong> em um novo arquivo. Vamos criar um pasta chamada includes, e dentro dela criaremos o arquivo <strong>class-wc-custom-api-endpoints.php</strong>. Extenderemos a classe <a href="https://developer.wordpress.org/reference/classes/wp_rest_controller/" target="_blank">WP_REST_Controller</a> (1) da qual iremos herdar o método <strong>&ldquo;register_routes&rdquo;</strong> (4), que irá registrar nossa rota de exemplo. Também declararemos uma propriedade privada <strong>$local_wpdb</strong>(2), que será instanciada em nosso método construtor da classe(3). A classe <a href="https://codex.wordpress.org/Class_Reference/wpdb" target="_blank">wpdb</a> do WordPress contém funcionalidades para interagir com o banco de dados e iremos utilizá-la para executar uma query que retornará os dados que precisamos. Para isso criamos o método chamado <strong>processing_order_items</strong> (5).</p>

<p>Para registrarmos nosso endpoint, vamos declarar uma variável que conterá nosso namespace e chamar a função <a href="https://developer.wordpress.org/reference/functions/register_rest_route/" target="_blank">register_rest_route</a> passando como parâmetros o namespace, a definição da rota, e os argumentos no forma de um array. Este array conterá um outro array com as opções &lsquo;methods&rsquo; e o &lsquo;callback&rsquo;. Como faremos uma chamada GET, usaremos a constante READABLE, da classe <strong>WP_REST_Server</strong>. No callback passaremos nosso método que retornará os itens dos pedidos.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">register_routes</span>() {
  $namespace <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;customapi/v1&#39;</span>;
  <span style="color:#a6e22e">register_rest_route</span>($namespace, <span style="color:#e6db74">&#39;/processing_order_items&#39;</span>, <span style="color:#66d9ef">array</span>(
	<span style="color:#66d9ef">array</span>(
		<span style="color:#e6db74">&#39;methods&#39;</span> 	<span style="color:#f92672">=&gt;</span> <span style="color:#a6e22e">WP_REST_Server</span><span style="color:#f92672">::</span><span style="color:#a6e22e">READABLE</span>,
		<span style="color:#e6db74">&#39;callback&#39;</span>	<span style="color:#f92672">=&gt;</span> <span style="color:#66d9ef">array</span>( $this, <span style="color:#e6db74">&#39;processing_order_items&#39;</span> )
	)
  ));
}
</code></pre></div>

<p>Feito isso, agora faremos a query SQL dentro do método para acessar o banco de dados.</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">function</span> <span style="color:#a6e22e">processing_order_items</span>() {
        $sql <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;SELECT woi.order_id, woi.order_item_name AS item_name, 
</span><span style="color:#e6db74">		MAX(IF(wom.meta_key = &#39;_qty&#39;, wom.meta_value, NULL)) AS qty FROM wpsu_woocommerce_order_items woi
</span><span style="color:#e6db74">		INNER JOIN wpsu_woocommerce_order_itemmeta wom 
</span><span style="color:#e6db74">		ON wom.order_item_id = woi.order_item_id
</span><span style="color:#e6db74">		WHERE woi.order_id IN 
</span><span style="color:#e6db74">		(SELECT ID FROM wpsu_posts WHERE post_status = &#39;wc-processing&#39; AND post_type = &#39;shop_order&#39;)
</span><span style="color:#e6db74">		AND woi.order_item_type = &#39;line_item&#39;
</span><span style="color:#e6db74">		GROUP BY woi.order_item_name&#34;</span>;
        $result <span style="color:#f92672">=</span> $this<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">local_wpdb</span><span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">get_results</span>($sql);
        <span style="color:#66d9ef">return</span> $result;
	}
</code></pre></div>

<p>Pronto, nosso endpoint agora está quase pronto. Ficou faltando apenas voltarmos no arquivo base de nosso plugin, <strong>woocommerce-custom-api-endpoint.php</strong>, e adicionarmos o seguinte código dentro da função  <strong>register_custom_routes</strong>,  e incluir a classe <strong>WC_Custom_Endpoint</strong>, como a seguir:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-php" data-lang="php"><span style="color:#75715e">&lt;?php</span>
<span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> <span style="color:#a6e22e">defined</span>( <span style="color:#e6db74">&#39;ABSPATH&#39;</span> ) ) {
	<span style="color:#66d9ef">exit</span>; <span style="color:#75715e">// Exit if accessed directly.
</span><span style="color:#75715e"></span>}

<span style="color:#66d9ef">if</span> ( <span style="color:#f92672">!</span> <span style="color:#a6e22e">class_exists</span>( <span style="color:#e6db74">&#39;WC_Custom_Endpoint&#39;</span> ) ) {
    <span style="color:#66d9ef">include_once</span> <span style="color:#a6e22e">dirname</span>( <span style="color:#66d9ef">__FILE__</span> ) <span style="color:#f92672">.</span> <span style="color:#e6db74">&#39;/includes/class-wc-custom-api-endpoints.php&#39;</span>;
}

<span style="color:#66d9ef">function</span> <span style="color:#a6e22e">register_custom_routes</span>() {
    $controller <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> <span style="color:#a6e22e">WC_Custom_Endpoint</span>();    
    $controller<span style="color:#f92672">-&gt;</span><span style="color:#a6e22e">register_routes</span>();
}

<span style="color:#a6e22e">add_action</span>(<span style="color:#e6db74">&#39;rest_api_init&#39;</span>, <span style="color:#e6db74">&#39;register_custom_routes&#39;</span>);
</code></pre></div>

<p>Agora sim poderemos realizar nossa chamada, como por exemplo:</p>

<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-zsh" data-lang="zsh">curl <span style="color:#e6db74">&#34;http://www.seusite.com/wp-json/customapi/v1/processing_order_items</span></code></pre></div>

<p>Este é um exemplo básico, poderíamos estender este artigo tratando de de outras questões, como autenticação para realizar a chamada, mas isto será assunto para um futuro post.</p>

<p>Até mais!</p>

        </div>

        
        
      </div>
    </div>
  </div>
</section>



<footer>
  <div class="container">
    <div class="row">
      <div class="col-12 text-center mb-5">
        <a href="https://guilherme00pereira.github.io/"><img src="https://guilherme00pereira.github.io/images/logo.png" alt="&lt;/G28&gt;"></a>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Contact Me</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark" href="tel:55-31-998220669"><i
                class="ti-mobile mr-3 text-primary"></i>55-31-998220669</a></li>
          <li class="mb-3"><i class="ti-location-pin mr-3 text-primary"></i>Belo Horizonte, Brazil</li>
          <li class="mb-3"><a class="text-dark" href="mailto:guilherme00pereira@gmail.com"><i
                class="ti-email mr-3 text-primary"></i>guilherme00pereira@gmail.com</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Social Contacts</h6>
        <ul class="list-unstyled">
          
          <li class="mb-3"><a class="text-dark" href="https://twitter.com/guilherme00per1" target="_blank">twitter</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://stackexchange.com/users/14371444/guilherme-pereira" target="_blank">stack overflow</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://github.com/guilherme00pereira" target="_blank">github</a></li>
          
          <li class="mb-3"><a class="text-dark" href="https://www.linkedin.com/in/guilhermepereirasalves/" target="_blank">linkedin</a></li>
          
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Categories</h6>
        <ul class="list-unstyled">
          <li class="mb-3"><a class="text-dark"
              href="/pt/categories/wordpress">Wordpress</a>
          </li>
        </ul>
      </div>
      <div class="col-lg-3 col-sm-6 mb-5">
        <h6 class="mb-4">Quick Links</h6>
        <ul class="list-unstyled">
          
        </ul>
      </div>
      <div class="col-12 border-top py-4 text-center">
        | @2019 All Rights Reserved |
      </div>
    </div>
  </div>
</footer>

<script>
  var indexURL = "https://guilherme00pereira.github.io/index.json"
</script>

<!-- Google Map API -->
<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCcABaamniA6OL5YvYSpB3pFMNrXwXnLwU&amp;libraries=places"></script>
<!-- JS Plugins -->

<script src="https://guilherme00pereira.github.io/plugins/jQuery/jquery.min.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/bootstrap/bootstrap.min.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/slick/slick.min.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/venobox/venobox.min.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/search/fuse.min.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/search/mark.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/search/search.js"></script>

<script src="https://guilherme00pereira.github.io/plugins/google-map/gmap.js"></script>

<!-- Main Script -->

<script src="https://guilherme00pereira.github.io/js/script.min.js"></script>
<!-- google analitycs -->
<script>
  (function (i, s, o, g, r, a, m) {
    i['GoogleAnalyticsObject'] = r;
    i[r] = i[r] || function () {
      (i[r].q = i[r].q || []).push(arguments)
    }, i[r].l = 1 * new Date();
    a = s.createElement(o),
      m = s.getElementsByTagName(o)[0];
    a.async = 1;
    a.src = g;
    m.parentNode.insertBefore(a, m)
  })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');
  ga('create', 'UA-136835996-1', 'auto');
  ga('send', 'pageview');
</script></body>
</html>